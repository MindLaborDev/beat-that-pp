(()=>{var t={21:t=>{function e(t,e=2){return~~(t*Math.pow(10,e))/Math.pow(10,e)}function s(t){if(0==t)return"0 Byte";var s=parseInt(Math.floor(Math.log(t)/Math.log(1024)));return e(t/Math.pow(1024,s))+" "+["Bytes","KB","MB","GB","TB"][s]}let a=!1;class n{static songs=[];static rankedSongs=[];static async getPlayerId(t){const e=`https://new.scoresaber.com/api/players/by-name/${t}`,s=await n.get(e);return s?1!==s.players.length?-2:s.players[0].playerId:-1}static async getPlayerData(t){const e=`https://new.scoresaber.com/api/player/${t}/full`,s=await n.get(e);return Object.assign(s.playerInfo,s.scoreStats)}static async getScores(t,e){const s=`https://new.scoresaber.com/api/player/${t}/scores/top/${e}`;return(await n.get(s)).scores}static async getSongData(t,e){if(n.songs[t])return n.songs[t];const s=`https://beatsaver.com/api/maps/by-hash/${t}`,a=await n.get(s);if(a.metadata.characteristics=a.metadata.characteristics.filter((t=>"Standard"===t.name)),!a.metadata.characteristics.length)return;const i=a.metadata.characteristics[0].difficulties[difficultiesMap[e]];return i?Object.assign(i,{cover:`https://beatsaver.com${a.coverURL}`,description:a.description,zip:`https://beatsaver.com${a.directDownload}`,key:a.key,name:a.name,heat:a.stats.heat,downloads:a.stats.downloads,difficulty:difficultiesMap[e]}):void 0}static async getMapDetails(t,e=!0){const s=`https://beatsaver.com/api/maps/detail/${t}`,a=await n.get(s);if(404!==a){if(e){const t=await n.get(`https://deep-beat.000webhostapp.com/?hash=${a.hash}`);a._diffs=JSON.parse(t)}return a}}static async getCoverBlob(t){const e=t.file("info.dat")||t.file("Info.dat"),s=await e.async("string");return JSON.parse(s),blob}static getAudioBlob(t,e=!1){return new Promise((async s=>{const a=new Audio;if(a.volume=.2,e);else{const e=t.file("info.dat")||t.file("Info.dat"),n=await e.async("string"),i=JSON.parse(n),o=i._songFilename,r=await t.file(o).async("blob"),l=i._coverImageFilename,c=await t.file(l).async("blob");a.src=URL.createObjectURL(r),a.currentTime=i._previewStartTime,a.onloadedmetadata=function(){s({audio:a,cover:c})}}}))}static async downloadMap(t){t.endsWith(".audica")&&(t=`https://bsaber-cors-anywhere.herokuapp.com/${t}`);const e=await fetch(t),a=s(e.headers.get("content-length"));if(console.log(a),200!=e.status)return;const n=new JSZip;return await n.loadAsync(e.blob())}static get(t){return new Promise((e=>{try{$.ajax({url:t,type:"get",success:async function(t,s){if("success"!==s)return console.error(s),void e({error:s});e(t)},error:t=>e(t.status)})}catch{e()}}))}}t.exports={clean:function(t){return`${t}`.replace(/<[^>]+>/g,"")},round:e,bytesToSize:s,convertDate:function(t){const e=new Date(t);return e.getDate()+" "+["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][e.getMonth()]+" "+e.getFullYear()},preview:function(t){const e=$("#preview-map");e.find("> iframe").attr("src",`https://skystudioapps.com/bs-viewer/?id=${t}`),a=!0,setTimeout((()=>{a&&e.removeClass("u-none")}),1500)},API:n}}},e={};function s(a){var n=e[a];if(void 0!==n)return n.exports;var i=e[a]={exports:{}};return t[a](i,i.exports,s),i.exports}(()=>{"use strict";const{round:t,bytesToSize:e,convertDate:a,API:n}=s(21);let i,o,r,l,c,d,p,u,f,h,m,g="nps",y={},b=!1;async function v(t,e){var s;e.endsWith(".zip")?(p=await async function(t,e=!1){D("Analysing your map...",91);const s=new JSZip,a=await s.loadAsync(t);if(e){const t=await a.file("song.desc").async("string");throw JSON.parse(t),"Audica files are not supported yet"}{const e=a.file("info.dat")||a.file("Info.dat"),s=await e.async("string"),i=JSON.parse(s);D("Analysing your map...",92);const o=i._difficultyBeatmapSets.find((t=>"Standard"===t._beatmapCharacteristicName));if(!o)return;if(null==c){o._difficultyBeatmaps.reverse();const t=o._difficultyBeatmaps.find((t=>[9,7,5,3,1].includes(t._difficultyRank)));if(o._difficultyBeatmaps.reverse(),!t)return;c=t._difficultyRank}const r={1:o._difficultyBeatmaps.find((t=>1===t._difficultyRank)),3:o._difficultyBeatmaps.find((t=>3===t._difficultyRank)),5:o._difficultyBeatmaps.find((t=>5===t._difficultyRank)),7:o._difficultyBeatmaps.find((t=>7===t._difficultyRank)),9:o._difficultyBeatmaps.find((t=>9===t._difficultyRank))},l=a.file(r[c]._beatmapFilename),p=await l.async("string"),u=JSON.parse(p);D("Analysing your map...",94);let f=await n.getAudioBlob(a);d=f.audio;let h=f.cover;return D("Analysing your map...",100),u._bombs=u._notes.filter((t=>3===t._type)),u._notes=u._notes.filter((t=>3!==t._type)),{infos:i,maps:r,beatmap:o,mapData:u,audio:d,cover:h,blob:t}}}(t,e.endsWith(".audica")),console.log(p),h=new M(p.mapData,p.infos._beatsPerMinute),$("#upload-section").addClass("u-none"),$("#analysis-content-wrapper").removeClass("u-none"),s={cover:`https://beatsaver.com${u?.coverURL}`,title:p.infos._songName,mapper:u?.uploader.username,likes:u?.stats.upVotes,dislikes:u?.stats.downVotes,oneclick:`beatsaver://${m}`,zip:e},$("#song-hero").html(`\n        <div class="song-img">\n            <img id="cover-img" class="u-circle u-center" />\n            <button class="js-listen-mobile btn-small u-center listen-btn">listen</button>\n        </div>\n        <div>\n            <h4>${s.title}</h4>\n            <p class="tooltip tooltip--bottom" data-tooltip="${a(u?.uploaded)}" style="width: fit-content;">Uploaded by ${s.mapper||"you"}</p>\n            <span>\n                ${s.likes||"-"} <i class="fas fa-heart"></i> &nbsp;&nbsp;\n                ${s.dislikes||"-"} <i class="fas fa-heart-broken"></i>\n            </span>\n        </div>\n        <div class="song-footer" id="install-btn-group">\n            ${"upload"===m?"":`<div class="my-2">\n                <div class="list-dropdown">\n                    <div class="btn-group">\n                        <button class="btn-primary" onclick="window.location.href = '${s.oneclick}';">Install</button>\n                        <button class="btn-primary btn-small btn-dropdown"><i class="fa fa-wrapper fa-caret-down" aria-hidden="true"></i></button>\n                        <ul class="menu">\n                            <li class="menu-item" id="download-map"><a>Download Map</a></li>\n                            ${"upload"===m?"":`<li class="menu-item" id="bsr-copy-btn" data-key="${m}"><a>Copy !bsr</a></li>`}\n                        </ul>\n                    </div>\n                </div>`}\n            <div class="my-2">\n                <button class="js-listen btn-small listen-btn">listen</button>\n            </div>\n        </div>\n    `),"upload"===m?(console.log(p),$("#cover-img")[0].src=URL.createObjectURL(p.cover)):$("#cover-img")[0].src=s.cover,$(".listen-btn").click((t=>{var e;e=t.currentTarget,S?(d.pause(),d.currentTime=p.infos._previewStartTime,$(".js-listen").text("Listen"),S=!1):async function(t){await d.play(),$(t).text("Stop"),$(t).removeClass("animated loading hide-text"),S=!0}(e)})),$("#bsr-copy-btn").click((t=>{var e;e="!bsr "+$(t.currentTarget).data("key"),navigator.clipboard?navigator.clipboard.writeText(e).then((function(){console.log("Async: Copying to clipboard was successful!")}),(function(t){console.error("Async: Could not copy text: ",t)})):function(t){var e=document.createElement("textarea");e.value=t,e.style.top="0",e.style.left="0",e.style.position="fixed",document.body.appendChild(e),e.focus(),e.select();try{var s=document.execCommand("copy")?"successful":"unsuccessful";console.log("Fallback: Copying text command was "+s)}catch(t){console.error("Fallback: Oops, unable to copy",t)}document.body.removeChild(e)}(e)})),$("#download-map").click((t=>{!function(){const t=document.createElement("a");t.style="display: none",document.body.appendChild(t);const e=URL.createObjectURL(p.blob);t.href=e,t.download=`${m} (${p.infos._songName} - ${p.infos._levelAuthorName}).zip`,t.click(),URL.revokeObjectURL(e)}()})),function(t){const e=t._difficultyBeatmaps.reduce(((t,e)=>{const s=c===e._difficultyRank?'class="selected"':"",a=e._customData?._difficultyLabel||difficultyDisplayMap[e._difficulty]||e._difficulty;return t+`<li data-did="${e._difficultyRank}" ${s}><div class="tab-item-content">${a}</div></li>`}),"");$("#difficulty-menu").html(`<ul>${e}</ul>`),$("#difficulty-menu").removeClass("not-loaded"),t._difficultyBeatmaps.forEach((t=>{$(`#difficulty-menu li[data-did="${t._difficultyRank}"]`).click((t=>{!async function(t){c=t;const e=new JSZip,s=(await e.loadAsync(p.blob)).file(p.maps[c]._beatmapFilename),a=await s.async("string");p.mapData=JSON.parse(a),p.mapData._bombs=p.mapData._notes.filter((t=>3===t._type)),p.mapData._notes=p.mapData._notes.filter((t=>3!==t._type)),h=new M(p.mapData,p.infos._beatsPerMinute),x(),k(),$("#difficulty-menu li").removeClass("selected"),$(`#difficulty-menu li[data-did="${c}"]`).addClass("selected"),C(g)}($(t.currentTarget).data("did"))}))}))}(p.beatmap),x(),k(),function(){let t=0,e=[];for(const s of y.npm)e.push(N(t)),t+=_;const s=document.getElementById("chart");f=new Chart(s,{type:"line",data:{labels:e,datasets:[{label:"NPS",data:y.npm,backgroundColor:"#f03d4d66",borderColor:"#f03d4d",borderWidth:1,fill:!0}]},options:{elements:{line:{tension:.2,cubicInterpolationMode:"monotone"},point:{radius:0}},normalized:!0,animation:!1}}),$("#chart-wrapper").removeClass("u-none")}(),C(g),function(){const t=$("li[id^='graph-toggle-']");t.each(((e,s)=>{$(s).click((e=>{const s=e.currentTarget.id.replace(/graph-toggle-/g,"");$(t).removeClass("selected"),$(e.currentTarget).addClass("selected"),C(s)}))}))}()):$("#generate-song-report").removeClass("animated loading hide-text")}$(document).ready((async function(){const s=location.hash.split(",");if(s.length<1)return void(window.location.href="/");if(s.length>2&&(c=+s[1]),m=s[0].substring(1),document.title="Fetching Map Details...","upload"!==m){if($("#analysis-content-wrapper").removeClass("u-none"),u=await n.getMapDetails(m),404===u)return;console.log(u)}else $("#upload-section").removeClass("u-none");let a,d;document.title=`Deep Beat | ${u?.name||"Analysing Beatmap..."}`,"upload"!==m&&(i=$("#progress"),o=$("#progress-status"),r=$("#progress-message"),l=$(".progress"),l.removeClass("not-loaded"),a=`https://beatsaver.com${u.directDownload}`,d=await async function(s){const a=await fetch(s),n=a.body.getReader(),i=+a.headers.get("content-length");let o=0,r=[],l=0;for(;;){const{done:s,value:a}=await n.read();if(s)break;if(r.push(a),o+=a.length,l%100==0){const s=t(90*o/i);D(`Downloading map ${e(o)} of ${e(i)}`,s)}l++}D(`Downloading map ${e(i)} of ${e(i)}`,90);const c=new Uint8Array(o);let d=0;for(const t of r)c.set(t,d),d+=t.length;return new Blob([c])}(a),await v(d,a)),$("#generate-song-report").click((async()=>{if(b)return;$("#file").removeClass("input-error");const t=$("#file")[0].files;if(0===t.length)return void $("#file").addClass("input-error");b=!0,$("#generate-song-report").addClass("animated loading hide-text");const e=t[0];await v(e,e.name),$("#generate-song-report").removeClass("animated loading hide-text")}))}));let _=5;function w(t,e){let s=p.audio.duration/60,a=[],n=1/0,i=0;_=~~(5*(s/2+1));for(const s of t){let t=~~(60*s._time/p.infos._beatsPerMinute/_);n===t?i+=null==s.value?1:s.value:(n=t,a.push(i*e/_),i=1)}let o=Math.ceil(p.audio.duration/_);for(;a.length<o;)a.push(0);return a}function x(){const e=function(){h.analyseSaberPath();let e,s=[],a=0;for(let e=1;e<h.rightSaberPath.length-1;e++){const n=h.rightSaberPath[e-1],i=h.rightSaberPath[e],o=h.rightSaberPath[e+1],r=M.getAngleBetweenVectors(i.x-n.x,i.y-n.y,o.x-i.x,o.y-i.y),l=Math.sqrt((i.x-o.x)*(i.x-o.x)+(i.y-o.y)*(i.y-o.y)),c=o.time-i.time,d=l/c,p=c>=.03?d:a;s.push({angle:t(r/(2*Math.PI),4),time:i.time,speed:p,note:i}),c>=.03&&(a=d)}let n=[],i=0;for(const t of s){if(e){if(t.angle<=.1){i++;continue}n.push({angle:1.5*Math.abs(t.angle-e.angle),skippedAngles:i,time:t.time,speed:t.speed,note:t.note}),i=0}e=t}let o=1/0,r=[],l=[],d=[],u=0,f=0,m=0,g=0;for(const t of n){let e=~~(60*t.time/_);if(o!==e){o=e;let s=p.maps[c]._noteJumpStartBeatOffset+3;s=s<.1?.1:s;const a=.4,n=t.time*p.infos._beatsPerMinute/60,i=(t.time+s)*p.infos._beatsPerMinute/60,y=h.getVisionBlockers(n,i);let b=y.right.length*a;y.left.length>0&&y.right.length>0&&(b+=a),r.push(0===g?0:8*u/g),l.push(0===g?0:1*f/g),d.push(0===g?0:m*(1+b)*4/g),u=0,f=0,m=0,g=0}u+=t.angle+.2*t.skippedAngles,f+=t.speed,m+=t.speed*(t.angle+.2*t.skippedAngles),g++}return{angleHistoryItems:r,speedHistoryItems:l,complexityHistoryItems:d}}(),s=h.getVisionBlockers(-1/0,1/0),a=w(h.notes,1),n=h.getJumps();y.jumps=n,y.npm=a,y.blockers=s,y.complexity=e}function k(){const e=p.maps[c]._customData?._requirements||[],s=[];for(const t of e){const e=modLinks[t]?`href="${modLinks[t]}" target="_blank"`:"";s.push(`<a ${e}>${t}</a>`)}const a=s.length>0?`Requires <span>${s.join(", ")}</span><br />`:"",n=~~(~~p.audio.duration/60),i=~~p.audio.duration%60;let o;u&&null!=u._diffs&&(o=u._diffs.find((t=>t.diff===c)));const r=['<div class="tag tag--primary bg-green-500 ml-1">Low</div>','<div class="tag tag--primary bg-yellow-400 ml-1">Moderate</div>','<div class="tag tag--primary bg-red-600 ml-1">High</div>','<div class="tag tag--primary bg-purple-600 ml-1">Very High</div>'],l=.015*p.mapData._notes.length,d=~~(Math.log2(y.jumps.jumpsCount/l)+1),f=r[d<0?0:d>r.length-1?r.length-1:d],h=.015*p.mapData._notes.length,m=~~(Math.log2((y.blockers.left.length+y.blockers.right.length)/h)+1),g=r[m<0?0:m>r.length-1?r.length-1:m];$("#map-general-info-wrapper").html(`\n        \x3c!-- https://cdn.wes.cloud/beatstar/bssb/v2-all.json --\x3e\n        ${a}<br />\n\n        <div id="map-general-infos">\n            <div>\n                ${u?.uploader.username?`\n                <div class="u-text-ellipsis">\n                    <span class="key-1 u-text-ellipsis">Uploader</span><span class="value-1">${u?.uploader.username}</span>\n                </div>`:""}\n                <div>\n                    <span class="key-1 u-text-ellipsis">Duration</span><span class="value-1">${n}min ${i}s</span>\n                </div>\n                <div>\n                    <span class="key-1 u-text-ellipsis">Artist</span><span class="value-1">${p.infos._songAuthorName}</span>\n                </div>\n                ${p.infos._songSubName?`\n                    <div>\n                        <span class="key-1 u-text-ellipsis">Subname</span><span class="value-1">${p.infos._songSubName}</span>\n                    </div>\n                `:""}\n                <div>\n                    <span class="key-1 u-text-ellipsis">&nbsp;</span>\n                </div>\n                <div>\n                    <span class="key-1 u-text-ellipsis">Notes</span><span class="value-1">${p.mapData._notes.length}</span>\n                </div>\n                <div>\n                    <span class="key-1 u-text-ellipsis">Obstacles</span><span class="value-1">${p.mapData._obstacles.length}</span>\n                </div>\n                <div>\n                    <span class="key-1 u-text-ellipsis">Bombs</span><span class="value-1">${p.mapData._bombs.length}</span>\n                </div>\n                <div>\n                    <span class="key-2 u-text-ellipsis">&nbsp;</span>\n                </div>\n                <div>\n                    <span class="key-3 u-text-ellipsis">Estimated jumps</span><span class="value-1" id="value-jumps">${y.jumps.jumpsCount}${f}</span>\n                </div>\n                <div>\n                    <span class="key-3 u-text-ellipsis">Vision blockers</span><span class="value-1" id="value-blockers">${y.blockers.left.length+y.blockers.right.length}${g}</span>\n                </div>\n            </div>\n            <div>\n                ${o?`\n                    <div>\n                        <span class="key-2 u-text-ellipsis">Stars</span><span class="value-2">${t(o.stars)} <i class="fas fa-star"></i></span>\n                    </div>\n                `:""}\n                ${o?`\n                    <div>\n                        <span class="key-2 u-text-ellipsis">Max pp</span><span class="value-2">${t(o.pp)} <i class="fab fa-pied-piper-pp"></i></span>\n                    </div>\n                `:""}\n                <div>\n                    <span class="key-2 u-text-ellipsis">&nbsp;</span>\n                </div>\n                <div>\n                    <span class="key-2 u-text-ellipsis">NPS</span><span class="value-2">${t(p.mapData._notes.length/p.audio.duration)}</span>\n                </div>\n                <div>\n                    <span class="key-2 u-text-ellipsis">NJS</span><span class="value-2">${t(p.maps[c]._noteJumpMovementSpeed)}</span>\n                </div>\n                <div>\n                    <span class="key-2 u-text-ellipsis">Offset</span><span class="value-2">${t(p.maps[c]._noteJumpStartBeatOffset)}</span>\n                </div>\n                <div>\n                    <span class="key-2 u-text-ellipsis">BPM</span><span class="value-2">${t(p.infos._beatsPerMinute)}</span>\n                </div>\n            </div>\n        </div>\n    `)}function C(t){switch(g=t,t){case"nps":f.data.datasets=[{label:"NPS",data:y.npm,backgroundColor:"#f03d4d66",borderColor:"#f03d4d",borderWidth:1,fill:!0}],f.update();break;case"comp":f.data.datasets=[{label:"Complexity",data:y.complexity.complexityHistoryItems,backgroundColor:"#f03d4d",borderColor:"#f03d4d",borderWidth:1},{label:"Readability (beta)",data:y.complexity.angleHistoryItems,backgroundColor:"#5e5cc766",borderColor:"#5e5cc7",borderWidth:1,fill:!0}],f.update();break;case"speed":f.data.datasets=[{label:"Speed",data:y.complexity.speedHistoryItems,backgroundColor:"#5e5cc766",borderColor:"#5e5cc7",borderWidth:1,fill:!0}],f.update();break;case"wrists":f.data.datasets=[{label:"Wrists",data:y.jumps.wrists,backgroundColor:"#0dd15766",borderColor:"#0dd157",borderWidth:1,fill:!0},{label:"Jumps",data:y.jumps.historyItems,backgroundColor:"#fdd15766",borderColor:"#fdd157",borderWidth:1,fill:!0}],f.update()}}function N(t){let e=~~(t/60),s=t%60;return`${e<10?"0"+e:e}:${s<10?"0"+s:s}`}function D(t,e){"upload"!==m&&(i.css("width",e+"%"),o.text(e+"%"),r.text(t),e>=100&&l.addClass("u-none"))}let S=!1;class B{constructor(t){this.position=M.getNoteBehind(t[0]._lineIndex,t[0]._lineLayer,t[0]._cutDirection)}traverse(t){this.position=t.path[t.path.length-1]}}class M{constructor(t){this.notes=t._notes.filter((t=>3!==t._type)),this.leftNotes=this.notes.filter((t=>0===t._type)),this.rightNotes=this.notes.filter((t=>1===t._type)),this.bombs=t._notes.filter((t=>3===t._type)),this.chunkedDataLeft=this.normalize(this.leftNotes),this.chunkedDataRight=this.normalize(this.rightNotes),this.leftBlockers=this.notes.filter((t=>1===t._lineIndex&&1===t._lineLayer)),this.rightBlockers=this.notes.filter((t=>2===t._lineIndex&&1===t._lineLayer)),this.sortedRightNotes=this.chunkedDataRight.flat(),this.sortedLeftNotes=this.chunkedDataLeft.flat()}getJumps(){let t={left:[],right:[]},e=[];for(let s=0;s<this.sortedRightNotes.length-1;s++){const a=M.getAngleBetweenDirectionCodes(this.sortedRightNotes[s],this.sortedRightNotes[s+1]),n=this.sortedRightNotes[s]._lineIndex-this.sortedRightNotes[s+1]._lineIndex,i=this.sortedRightNotes[s]._lineLayer-this.sortedRightNotes[s+1]._lineLayer,o=this.sortedRightNotes[s+1]._time-this.sortedRightNotes[s]._time,r=M.beatToTime(o),l=Math.sqrt(n*n+i*i);(a>.374&&l>2.5||l>1.9&&a>=.49)&&r<.15&&(t.right.push(this.sortedRightNotes[s]),e.push(Object.assign(this.sortedRightNotes[s],{value:l*(6*(.3-r))+(.5-a)})))}for(let s=0;s<this.sortedLeftNotes.length-1;s++){const a=M.getAngleBetweenDirectionCodes(this.sortedLeftNotes[s],this.sortedLeftNotes[s+1]),n=this.sortedLeftNotes[s]._lineIndex-this.sortedLeftNotes[s+1]._lineIndex,i=this.sortedLeftNotes[s]._lineLayer-this.sortedLeftNotes[s+1]._lineLayer,o=this.sortedLeftNotes[s+1]._time-this.sortedLeftNotes[s]._time,r=M.beatToTime(o),l=Math.sqrt(n*n+i*i);(a>.374&&l>2.5||l>1.9&&a>=.49)&&r<.15&&(t.left.push(this.sortedLeftNotes[s]),e.push(Object.assign(this.sortedLeftNotes[s],{value:l*(6*(.3-r))+(.5-a)})))}const s=t.right.concat(t.left).sort(((t,e)=>t._time-e._time));let a=0,n=[];for(const t of s){const e=M.beatToTime(t._time);e-a<.5&&n.push(t),a=e}return{historyItems:w(n,1),wrists:w(e,2),jumpsCount:n.length}}getVisionBlockers(t,e){return{left:this.leftBlockers.filter((s=>s._time>t&&s._time<e)),right:this.rightBlockers.filter((s=>s._time>t&&s._time<e))}}analyseSaberPath(){const t=new B(this.chunkedDataRight[0]),e=new B(this.chunkedDataLeft[0]);this.rightSaberPath=this.determineSaberPath(t),this.leftSaberPath=this.determineSaberPath(e)}determineSaberPath(t){let e=[t.position];for(const s of this.chunkedDataRight){1===e.length&&(e[0].time=0);const a=this.orderChunk(s,t.position);t.traverse(a),a.path.shift(),e=e.concat(a.path)}return e}orderChunk(t,e){let s,a,n=1/0;const i=this.permutations(t);for(const t of i){const i=e||{x:t[0]._lineIndex,y:t[0]._lineLayer},o=this.traverseChunk(t,i);n>o.sumAngle&&(n=o.sumAngle,a=o.traversal,s=t)}return{angle:n,chunk:s,path:a}}traverseChunk(t,e){const s=[{x:e.x,y:e.y}];for(const e of t){if(1===s.length&&(s[0].time=M.beatToTime(e._time)),s.push({x:e._lineIndex,y:e._lineLayer,time:M.beatToTime(e._time)}),8===e._cutDirection)continue;const t=this.getNoteAfter(e._lineIndex,e._lineLayer,e._cutDirection);s.push({x:t.x,y:t.y,time:M.beatToTime(e._time)})}let a,n=[];for(const t of s)null!=a&&t.x===a.x&&t.y===a.y||(n.push(t),a=t);let i=0;for(let t=0;t<n.length-2;t++){const e=n[t+1].x-n[t].x,s=n[t+1].y-n[t].y,a=n[t+2].x-n[t+1].x,o=n[t+2].y-n[t+1].y;i+=M.getAngleBetweenVectors(e,s,a,o)}return{traversal:n,sumAngle:i<.001?0:i}}static getAngleBetweenVectors(t,e,s,a){const n=Math.acos((t*s+e*a)/(Math.sqrt(t*t+e*e)*Math.sqrt(s*s+a*a)));return n<.001?0:n}static getNoteBehind(t,e,s){switch(s){case 0:return{x:t,y:e-1};case 1:return{x:t,y:e+1};case 2:return{x:t+1,y:e};case 3:return{x:t-1,y:e};case 4:return{x:t+1,y:e-1};case 5:return{x:t-1,y:e-1};case 6:return{x:t+1,y:e+1};case 7:return{x:t-1,y:e+1};default:return{x:t,y:e}}}getNoteAfter(t,e,s){switch(s){case 0:return{x:t,y:e+1};case 1:return{x:t,y:e-1};case 2:return{x:t-1,y:e};case 3:return{x:t+1,y:e};case 4:return{x:t-1,y:e+1};case 5:return{x:t+1,y:e+1};case 6:return{x:t-1,y:e-1};case 7:return{x:t+1,y:e-1};default:return{x:t,y:e}}}static getAngleBetweenDirectionCodes(t,e){const s=[0,.5,.25,.25,.125,.125,.375,.375,0];let a=t._cutDirection,n=e._cutDirection;return Math.abs(s[n]-s[a])}permutations(t){let e=[];for(let s=0;s<t.length;s+=1){let a=this.permutations(t.slice(0,s).concat(t.slice(s+1)));if(a.length)for(let n=0;n<a.length;n+=1)e.push([t[s]].concat(a[n]));else e.push([t[s]])}return e}normalize(t){let e=0,s=[],a=[];for(const n of t)n._time!==e&&s.length>0&&(a.push(s),s=[]),s.push(n),e=n._time;return a}static beatToTime(t){return 60*+t/p.infos._beatsPerMinute}}})()})();